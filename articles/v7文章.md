> è¯¥ç³»åˆ—æ–‡ç« åŸºäº `github.com/shareAI-lab/learn-claude-code` å†™å°±ï¼Œè¯¥ä»“åº“ä»¥å¤§é“è‡³ç®€çš„é£æ ¼å‰–æäº†Claude Codeçš„æ ¸å¿ƒåŸç†ï¼Œå€¼å¾—å¤§å®¶å­¦ä¹ ã€‚ç”±äºè¯¥ä»“åº“æ˜¯åŸºäºPythonè¯­è¨€ï¼Œä¸ºæ–¹ä¾¿.NETå¼€å‘è€…å­¦ä¹ ï¼Œæˆ‘å·²ç»å°†ä»£ç åŸºäº.NET 10çš„`dotnet file` é‡å†™ï¼Œæºç å·²ä¸Šä¼ è‡³githubï¼Œæºç åœ°å€è§æ–‡æœ«ã€‚

# v7: åå°ä»»åŠ¡ - æ°¸ä¸é˜»å¡çš„æ™ºèƒ½ä½“

> æœ¬æ–‡æ˜¯ Learn Claude Code (C# ç‰ˆ) ç³»åˆ—çš„ç¬¬å…«ç¯‡ï¼Œå¯¹åº”ä»£ç æ–‡ä»¶ `v7_background_tasks_agent.cs`ã€‚

## é—®é¢˜ï¼šé•¿å‘½ä»¤é˜»å¡æ•´ä¸ªå¾ªç¯

v6 ç»™äº†æˆ‘ä»¬æŒä¹…åŒ–ä»»åŠ¡çœ‹æ¿ï¼Œä½†å·¥å…·æ‰§è¡Œä»ç„¶æ˜¯åŒæ­¥çš„ï¼š

```
ç”¨æˆ·: "Run the full test suite"

Agent è°ƒç”¨ bash("dotnet test") â†’ ç­‰å¾… 3 åˆ†é’Ÿ â†’ ğŸ•
  æ•´ä¸ªå¾ªç¯å†»ç»“
  ç”¨æˆ·ä»€ä¹ˆéƒ½åšä¸äº†
  LLM æ²¡æœ‰åœ¨æ€è€ƒ
  CPU åœ¨ç©ºè·‘ç­‰å¾…
```

åœ¨çœŸå®é¡¹ç›®ä¸­ï¼Œæ„å»ºã€æµ‹è¯•ã€éƒ¨ç½²åŠ¨è¾„æ•°åˆ†é’Ÿã€‚è®©æ™ºèƒ½ä½“å¹²ç­‰ç€æ˜¯æå¤§çš„æµªè´¹ã€‚

## è§£å†³æ–¹æ¡ˆï¼šåå°è¿è¡Œ + é€šçŸ¥æ’ç©º

BackgroundManager åœ¨ç‹¬ç«‹çº¿ç¨‹ä¸­è¿è¡Œå‘½ä»¤ï¼Œåœ¨æ¯æ¬¡ LLM è°ƒç”¨å‰æ’ç©ºé€šçŸ¥é˜Ÿåˆ—ï¼Œä½¿æ™ºèƒ½ä½“æ°¸è¿œä¸ä¼šå› é•¿æ—¶é—´è¿è¡Œçš„æ“ä½œè€Œé˜»å¡ã€‚

```
ç”¨æˆ·: "Run tests in background"

+-------------------+
| Agent Loop        |
|                   |       background_run("dotnet test")
|  [ç»§ç»­å¤„ç†å…¶ä»–äº‹]  |  â”€â”€â†’  +------------------+
|  [å›ç­”æ›´å¤šé—®é¢˜]    |       | Thread: Process  |
|  [è¯»å†™æ–‡ä»¶]        |       | running...       |
|                   |       +------------------+
|  [LLM è°ƒç”¨å‰]     |              |
|  â† DrainNotify â†  |â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ (å®Œæˆé€šçŸ¥)
+-------------------+
```

## BackgroundManager æ ¸å¿ƒç±»

```csharp
class BackgroundManager
{
    ConcurrentDictionary<string, BgTaskInfo> tasks = new();
    ConcurrentQueue<BgNotification> notifications = new();

    public string RunInBackground(string command)
    {
        var id = $"bg_{Interlocked.Increment(ref _seq)}";
        var info = new BgTaskInfo(id, command);
        tasks[id] = info;

        // ç‹¬ç«‹çº¿ç¨‹æ‰§è¡Œ
        Task.Run(() =>
        {
            var proc = Process.Start(new ProcessStartInfo
            {
                FileName = "bash",
                Arguments = $"-c \"{command.Replace("\"", "\\\"")}\"",
                RedirectStandardOutput = true,
                RedirectStandardError = true,
            });
            // ... ç­‰å¾…å®Œæˆ ...

            info.Status = "done";
            info.Output = stdout;

            // æ¨å…¥é€šçŸ¥é˜Ÿåˆ—
            notifications.Enqueue(new BgNotification(id, "done", stdout));
        });

        return $"Started background task {id}";
    }
}
```

æ ¸å¿ƒæ•°æ®ç»“æ„é€‰æ‹©ï¼š
- **`ConcurrentDictionary`**ï¼šçº¿ç¨‹å®‰å…¨çš„ä»»åŠ¡æ³¨å†Œè¡¨
- **`ConcurrentQueue`**ï¼šæ— é”çš„é€šçŸ¥é˜Ÿåˆ—

## é€šçŸ¥æ’ç©ºæœºåˆ¶

**å…³é”®è®¾è®¡**ï¼šåœ¨æ¯æ¬¡ LLM è°ƒç”¨å‰ï¼Œæ’ç©ºé€šçŸ¥é˜Ÿåˆ—å¹¶æ³¨å…¥åˆ°æ¶ˆæ¯æµä¸­ï¼š

```csharp
string DrainNotifications()
{
    var items = new List<string>();
    while (notifications.TryDequeue(out var n))
        items.Add($"[Background {n.Id}] Status: {n.Status}\n{n.Output}");

    return items.Count > 0 ? string.Join("\n---\n", items) : "";
}
```

åœ¨ Agent Loop ä¸­ï¼š

```csharp
while (true)
{
    MicroCompact(messages);

    // æ’ç©ºåå°é€šçŸ¥, æ³¨å…¥åˆ°æ¶ˆæ¯æµ
    var bgNotices = bgManager.DrainNotifications();
    if (!string.IsNullOrEmpty(bgNotices))
    {
        messages.Add(new()
        {
            Role = Role.User,
            Content = $"<background-results>\n{bgNotices}\n</background-results>"
        });
    }

    var response = await client.Messages.Create(...);
    // ... æ­£å¸¸å·¥å…·æ‰§è¡Œ ...
}
```

æ¶ˆæ¯ä»¥ `<background-results>` æ ‡ç­¾åŒ…è£¹ï¼Œè®© LLM èƒ½åŒºåˆ†è¿™æ˜¯å¼‚æ­¥å®Œæˆçš„åå°ç»“æœã€‚

## å·¥å…·è®¾è®¡

æ–°å¢ 2 ä¸ªå·¥å…·ï¼š

| å·¥å…· | å‚æ•° | è¯´æ˜ |
|------|------|------|
| `background_run` | command | åœ¨åå°çº¿ç¨‹ä¸­å¯åŠ¨å‘½ä»¤ |
| `check_background` | task_id (å¯é€‰) | æ£€æŸ¥åå°ä»»åŠ¡çŠ¶æ€ |

```csharp
"background_run" => bgManager.RunInBackground(input["command"]),
"check_background" => bgManager.CheckStatus(
    input.TryGetProperty("task_id", out var tid) ? tid.GetString() : null),
```

## ç›¸å¯¹ v6 çš„å˜æ›´

| ç»„ä»¶ | ä¹‹å‰ (v6) | ä¹‹å (v7) |
|------|-----------|-----------|
| Tools | 8 (åŸºç¡€ + task) | 6 (åŸºç¡€ + bg) |
| æ‰§è¡Œæ¨¡å¼ | çº¯åŒæ­¥ | åŒæ­¥ + åå°çº¿ç¨‹ |
| é˜»å¡è¡Œä¸º | bash é˜»å¡å¾ªç¯ | background_run ç«‹å³è¿”å› |
| ç»“æœä¼ é€’ | åŒæ­¥è¿”å› tool_result | é€šçŸ¥é˜Ÿåˆ—æ³¨å…¥æ¶ˆæ¯ |
| çº¿ç¨‹å®‰å…¨ | ä¸éœ€è¦ | ConcurrentDictionary + ConcurrentQueue |

> æ³¨ï¼šv7 ä¸“æ³¨äºåå°æ‰§è¡Œæœºåˆ¶ï¼ŒæœªåŒ…å« v6 çš„ä»»åŠ¡çœ‹æ¿ï¼ˆåç»­ç‰ˆæœ¬ä¼šå°†ä¸¤è€…åˆå¹¶ï¼‰ã€‚

## è®¾è®¡åŸç†

åå°æ‰§è¡Œæœ¬è´¨ä¸Šåªéœ€è¦ä¸¤ä¸ªæ¦‚å¿µï¼š

1. **Fire-and-forget å¯åŠ¨**ï¼šç‹¬ç«‹çº¿ç¨‹è¿è¡Œå‘½ä»¤ï¼Œä¸»å¾ªç¯ç«‹å³ç»§ç»­
2. **Drain-before-call äº¤ä»˜**ï¼šæ¯æ¬¡ LLM è°ƒç”¨å‰æ£€æŸ¥å®Œæˆé˜Ÿåˆ—

C# çš„ `ConcurrentQueue` å’Œ `ConcurrentDictionary` æ˜¯å¤©ç„¶çš„é€‰æ‹©â€”â€”æ— é”ã€ç±»å‹å®‰å…¨ã€æ— éœ€æ‰‹åŠ¨åŠ é”ã€‚ç›¸æ¯” Python ç‰ˆæœ¬ä½¿ç”¨ `threading.Lock`ï¼ŒC# çš„å¹¶å‘é›†åˆè®©ä»£ç æ›´ç®€æ´ã€‚

## è¿è¡Œ

```bash
dotnet run v7_background_tasks_agent.cs
```

å¯ä»¥å°è¯•çš„æç¤ºï¼š
1. `Run 'ping -n 10 localhost' in the background, then ask me a question while it runs`
2. `Check background tasks`ï¼ˆè§‚å¯Ÿé€šçŸ¥ä¼šè‡ªåŠ¨æ³¨å…¥åˆ°ä¸‹ä¸€æ¬¡ LLM è°ƒç”¨ä¸­ï¼‰
3. `Start three background tasks and keep chatting`ï¼ˆè§‚å¯Ÿå¤šä»»åŠ¡å¹¶å‘ï¼‰
