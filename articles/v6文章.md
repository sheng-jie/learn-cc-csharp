> è¯¥ç³»åˆ—æ–‡ç« åŸºäº `github.com/shareAI-lab/learn-claude-code` å†™å°±ï¼Œè¯¥ä»“åº“ä»¥å¤§é“è‡³ç®€çš„é£æ ¼å‰–æäº†Claude Codeçš„æ ¸å¿ƒåŸç†ï¼Œå€¼å¾—å¤§å®¶å­¦ä¹ ã€‚ç”±äºè¯¥ä»“åº“æ˜¯åŸºäºPythonè¯­è¨€ï¼Œä¸ºæ–¹ä¾¿.NETå¼€å‘è€…å­¦ä¹ ï¼Œæˆ‘å·²ç»å°†ä»£ç åŸºäº.NET 10çš„`dotnet file` é‡å†™ï¼Œæºç å·²ä¸Šä¼ è‡³githubï¼Œæºç åœ°å€è§æ–‡æœ«ã€‚

# v6: ä»»åŠ¡ç³»ç»Ÿ - æ–‡ä»¶ç³»ç»Ÿä¸Šçš„æŒä¹…åŒ–ä»»åŠ¡çœ‹æ¿

> æœ¬æ–‡æ˜¯ Learn Claude Code (C# ç‰ˆ) ç³»åˆ—çš„ç¬¬ä¸ƒç¯‡ï¼Œå¯¹åº”ä»£ç æ–‡ä»¶ `v6_task_system_agent.cs`ã€‚

## é—®é¢˜ï¼šå‹ç¼©ä¼šæ¸…é™¤è®°å¿†

v5 çš„ä¸Šä¸‹æ–‡å‹ç¼©è§£å†³äº†çª—å£æº¢å‡ºé—®é¢˜ï¼Œä½†å¸¦æ¥äº†å‰¯ä½œç”¨ï¼š

**å½“å¯¹è¯è¢«å‹ç¼©æ—¶ï¼Œæ‰€æœ‰çš„ä»»åŠ¡çŠ¶æ€éƒ½ä¸¢å¤±äº†ã€‚**

æƒ³è±¡ä½ åœ¨ç®¡ç†ä¸€ä¸ª 10 ä¸ªä»»åŠ¡çš„é¡¹ç›®ï¼š

```
å‹ç¼©å‰ï¼š
  Task 1: done âœ“
  Task 2: in-progress ğŸ”„
  Task 3: blocked by Task 2 â³
  ... (å…¨åœ¨ä¸Šä¸‹æ–‡ä¸­)

å‹ç¼©åï¼š
  [Summary]: "ç”¨æˆ·åœ¨å¤„ç†ä¸€ä¸ªå¤šä»»åŠ¡é¡¹ç›®"
  ...å…·ä½“ä»»åŠ¡? ä¸çŸ¥é“äº†
```

ä½ éœ€è¦ä¸€ç§æ–¹å¼è®©çŠ¶æ€**å­˜æ´»äºä¸Šä¸‹æ–‡å‹ç¼©ä¹‹å¤–**ã€‚

## è§£å†³æ–¹æ¡ˆï¼šæ–‡ä»¶ç³»ç»Ÿä¸Šçš„ä»»åŠ¡çœ‹æ¿

ä»»åŠ¡ä»¥ JSON æ–‡ä»¶æŒä¹…åŒ–åœ¨ `.tasks/` ç›®å½•ä¸­ï¼Œæ¯ä¸ªä»»åŠ¡ä¸€ä¸ªæ–‡ä»¶ï¼š

```
.tasks/
  â”œâ”€â”€ task_001.json     â† { "id": "001", "title": "...", "status": "done" }
  â”œâ”€â”€ task_002.json     â† { "id": "002", "title": "...", "status": "in-progress" }
  â””â”€â”€ task_003.json     â† { "id": "003", "blockedBy": ["002"], ... }
```

```
Agent Context                    File System (.tasks/)
+------------------+            +------------------+
| Messages[]       |            | task_001.json    |
| (can be cleared) |  â†--è¯»å–--â†’ | task_002.json    |
|                  |            | task_003.json    |
+------------------+            +------------------+
     â†‘ volatile                      â†‘ persistent
```

## TaskManager æ ¸å¿ƒç±»

```csharp
class TaskManager
{
    string taskDir;
    int nextId;

    public TaskManager()
    {
        taskDir = ".tasks";
        Directory.CreateDirectory(taskDir);
        // ... ä»å·²æœ‰æ–‡ä»¶æ¨æ–­ nextId ...
    }
```

### åˆ›å»ºä»»åŠ¡

```csharp
    public string Create(string title, string description, List<string>? blockedBy)
    {
        var id = $"{nextId++:D3}";
        var task = new Dictionary<string, object>
        {
            ["id"] = id,
            ["title"] = title,
            ["description"] = description,
            ["status"] = "pending",
            ["blockedBy"] = blockedBy ?? [],
            ["blocks"] = new List<string>()
        };

        // åŒå‘ä¾èµ–è¿æ¥
        if (blockedBy != null)
            foreach (var depId in blockedBy)
            {
                var dep = Load(depId);
                ((List<string>)dep["blocks"]).Add(id);
                Save(depId, dep);
            }

        Save(id, task);
        return id;
    }
```

### ä¾èµ–å›¾

```csharp
    // å®Œæˆä»»åŠ¡æ—¶, è‡ªåŠ¨ä»ä¸‹æ¸¸ä»»åŠ¡çš„ blockedBy ä¸­ç§»é™¤è‡ªå·±
    public void ClearDependency(string finishedId)
    {
        var finished = Load(finishedId);
        foreach (var downId in (List<string>)finished["blocks"])
        {
            var down = Load(downId);
            ((List<string>)down["blockedBy"]).Remove(finishedId);
            Save(downId, down);
        }
    }
```

å½“æ›´æ–°ä»»åŠ¡çŠ¶æ€ä¸º `done` æ—¶ï¼Œè‡ªåŠ¨è°ƒç”¨ `ClearDependency`ï¼š

```csharp
    public void Update(string id, string? status, string? title)
    {
        var task = Load(id);
        if (title != null) task["title"] = title;
        if (status != null)
        {
            task["status"] = status;
            if (status == "done") ClearDependency(id);
        }
        Save(id, task);
    }
```

## å·¥å…·å®šä¹‰

é™¤äº†åŸæœ‰çš„ 4 ä¸ªåŸºç¡€å·¥å…·å¤–ï¼Œæ–°å¢ 4 ä¸ªä»»åŠ¡å·¥å…·ï¼š

| å·¥å…· | å‚æ•° | è¯´æ˜ |
|------|------|------|
| `task_create` | title, description, blocked_by | åˆ›å»ºä»»åŠ¡ï¼Œè‡ªåŠ¨å»ºç«‹åŒå‘ä¾èµ– |
| `task_update` | task_id, status, title | æ›´æ–°ä»»åŠ¡çŠ¶æ€ï¼Œå®Œæˆæ—¶è‡ªåŠ¨æ¸…é™¤ä¾èµ– |
| `task_list` | - | åˆ—å‡ºæ‰€æœ‰ä»»åŠ¡æ¦‚è§ˆ |
| `task_get` | task_id | è·å–å•ä¸ªä»»åŠ¡è¯¦æƒ… |

## Agent Loop æ•´åˆ

åœ¨å·¥å…·æ‰§è¡Œçš„ switch ä¸­å¢åŠ ä»»åŠ¡ç›¸å…³åˆ†æ”¯ï¼š

```csharp
var result = toolName switch
{
    "bash" => RunBash(input),
    "read_file" => File.ReadAllText(input["path"]),
    "write_file" => WriteFile(input),
    "edit_file" => EditFile(input),
    "task_create" => taskManager.Create(
        input["title"], input["description"],
        input.TryGetProperty("blocked_by", out var bb)
            ? bb.EnumerateArray().Select(x => x.GetString()!).ToList()
            : null),
    "task_update" => taskManager.Update(...),
    "task_list" => taskManager.ListAll(),
    "task_get" => taskManager.Get(input["task_id"]),
    _ => $"Unknown tool: {toolName}"
};
```

## ç›¸å¯¹ v5 çš„å˜æ›´

| ç»„ä»¶ | ä¹‹å‰ (v5) | ä¹‹å (v6) |
|------|-----------|-----------|
| Tools | 5 (åŸºç¡€ + compact) | 8 (+ 4 task å·¥å…·) |
| ä¸Šä¸‹æ–‡ç®¡ç† | ä¸‰å±‚å‹ç¼© | ä¸‰å±‚å‹ç¼© (ç»§æ‰¿) |
| æŒä¹…åŒ–çŠ¶æ€ | æ—  (ä»… transcript) | `.tasks/` JSON æ–‡ä»¶ |
| ä¾èµ–ç®¡ç† | æ—  | åŒå‘ blockedBy/blocks |
| çŠ¶æ€æ¢å¤ | æ— æ³•æ¢å¤ | å‹ç¼©åä»å¯è¯»å– |

## è®¾è®¡åŸç†

æ–‡ä»¶ç³»ç»Ÿæ˜¯æœ€ç®€å•çš„æŒä¹…åŒ–æ–¹æ¡ˆï¼šæ— éœ€æ•°æ®åº“ï¼Œæ— éœ€åºåˆ—åŒ–æ¡†æ¶ï¼Œ`JSON` + æ–‡ä»¶ç›®å½•å°±æ˜¯ä¸€ä¸ªåŠŸèƒ½å®Œæ•´çš„ä»»åŠ¡çœ‹æ¿ã€‚

å…³é”®è®¾è®¡é€‰æ‹©ï¼š
- **æ¯ä¸ªä»»åŠ¡ä¸€ä¸ªæ–‡ä»¶**ï¼šé¿å…å¹¶å‘å†™å…¥å†²çªï¼Œæ–¹ä¾¿å•ä»»åŠ¡è¯»å†™
- **åŒå‘ä¾èµ–é“¾æ¥**ï¼š`blockedBy` è®°å½•ä¸Šæ¸¸ï¼Œ`blocks` è®°å½•ä¸‹æ¸¸ï¼Œå®Œæˆæ—¶åå‘æ¸…ç†
- **çŠ¶æ€è½¬æ¢è§¦å‘å™¨**ï¼š`done` çŠ¶æ€è‡ªåŠ¨çº§è” `ClearDependency`

ä»»åŠ¡ç³»ç»Ÿçš„ä»·å€¼åœ¨äº**è®©çŠ¶æ€å¤–éƒ¨åŒ–**â€”â€”å®ƒä¸å†å…³å¿ƒä¸Šä¸‹æ–‡çª—å£å‘ç”Ÿäº†ä»€ä¹ˆã€‚

## è¿è¡Œ

```bash
dotnet run v6_task_system_agent.cs
```

å¯ä»¥å°è¯•çš„æç¤ºï¼š
1. `Create a plan with 5 tasks for building a REST API, with proper dependencies`
2. `Show me all tasks`ï¼ˆè§‚å¯Ÿ `.tasks/` ç›®å½•ä¸­çš„ JSON æ–‡ä»¶ï¼‰
3. `Mark task 001 as done`ï¼ˆè§‚å¯Ÿä¾èµ–è‡ªåŠ¨æ¸…ç†ï¼‰
